{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Buchung bearbeiten</h1>
  <a href="{{ url_for('dashboard.dashboard', year=request.args.get('year'), month=request.args.get('month'), page=request.args.get('page', 1)) }}" class="btn btn-outline-secondary">Zurück zum Dashboard</a>
</div>

{% if get_flashed_messages() %}
  <div class="mb-3">
    {% for msg in get_flashed_messages(with_categories=true) %}
      {% set cat, text = msg %}
      <div class="alert alert-{{ 'success' if cat == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ text }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<form method="post" id="edit-form">
  <div class="mb-3">
    <label for="datum" class="form-label">Datum</label>
    <input type="date" class="form-control" id="datum" name="datum" value="{{ buchung.datum.strftime('%Y-%m-%d') if buchung.datum else '' }}" required>
  </div>

  <div class="mb-3">
    <label for="art" class="form-label">Art</label>
    <input type="text" class="form-control" id="art" name="art" value="{{ buchung.art }}" placeholder="z.B. Überweisung, Barzahlung">
  </div>

  <div class="mb-3">
    <label for="typ" class="form-label">Typ</label>
    <select class="form-select" id="typ" name="typ" required>
      <option value="Ausgaben" {% if buchung.soll > 0 %}selected{% endif %}>Ausgaben</option>
      <option value="Einnahmen" {% if buchung.haben > 0 %}selected{% endif %}>Einnahmen</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="betrag" class="form-label">Betrag</label>
    <input type="text" class="form-control" id="betrag" name="betrag" 
           value="{% if buchung.soll > 0 %}{{ "%.2f"|format(buchung.soll) }}{% elif buchung.haben > 0 %}{{ "%.2f"|format(buchung.haben) }}{% else %}0.00{% endif %}" 
           inputmode="decimal" placeholder="z.B. 25,50" required>
  </div>

  <div class="mb-3">
    <label for="kategorie" class="form-label">Kategorie</label>
    <select class="form-select" id="kategorie" name="kategorie" required>
      <option value="">Bitte wählen</option>
      {% for k in kategorien %}
        <option value="{{ k }}" {% if k == buchung.kategorie %}selected{% endif %}>{{ k }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label for="kategorie2" class="form-label">Unterkategorie</label>
    <input type="text" class="form-control" id="kategorie2" name="kategorie2"
           value="{{ buchung.kategorie2 or '' }}" placeholder="z.B. Lebensmittel, Tanken">
  </div>

  <div class="mb-3">
    <label for="beschreibung" class="form-label">Beschreibung</label>
    <textarea class="form-control" id="beschreibung" name="beschreibung" rows="3" placeholder="z.B. Barzahlung Supermarkt" required>{{ buchung.beschreibung }}</textarea>
  </div>

  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" role="switch" id="manually_edit" name="manually_edit"
           {% if buchung.manually_edit %}checked{% endif %}>
    <label class="form-check-label" for="manually_edit">Manuell bearbeitet (neue Kategorie wird nicht automatisch gesetzt!)</label>
  </div>
</form>

<div class="d-flex justify-content-between align-items-center mt-3">
  <button type="submit" class="btn btn-primary" form="edit-form">Speichern</button>

  <form method="post"
        action="{{ url_for('actions.delete_buchung', buchung_id=buchung.id, year=request.args.get('year'), month=request.args.get('month'), page=request.args.get('page', 1)) }}"
        onsubmit="return confirm('Buchung wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.');">
    <button type="submit" class="btn btn-outline-danger">Löschen</button>
  </form>
</div>
{% endblock %}
