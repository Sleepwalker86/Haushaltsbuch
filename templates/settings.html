{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Einstellungen</h1>

{% if get_flashed_messages() %}
  <div class="mb-3">
    {% for msg in get_flashed_messages(with_categories=true) %}
      {% set cat, text = msg %}
      <div class="alert alert-{{ 'success' if cat == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ text }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<ul class="nav nav-tabs mb-3" id="settingsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'konten' %}active{% endif %}" id="konten-tab"
            data-bs-toggle="tab" data-bs-target="#konten-pane" type="button" role="tab"
            aria-controls="konten-pane" aria-selected="{% if active_tab == 'konten' %}true{% else %}false{% endif %}">
      Konten
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'keywords' %}active{% endif %}" id="keywords-tab"
            data-bs-toggle="tab" data-bs-target="#keywords-pane" type="button" role="tab"
            aria-controls="keywords-pane" aria-selected="{% if active_tab == 'keywords' %}true{% else %}false{% endif %}">
      Kategorien & Schlüsselwörter
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'paperless' %}active{% endif %}" id="paperless-tab"
            data-bs-toggle="tab" data-bs-target="#paperless-pane" type="button" role="tab"
            aria-controls="paperless-pane" aria-selected="{% if active_tab == 'paperless' %}true{% else %}false{% endif %}">
      Paperless
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'export' %}active{% endif %}" id="export-tab"
            data-bs-toggle="tab" data-bs-target="#export-pane" type="button" role="tab"
            aria-controls="export-pane" aria-selected="{% if active_tab == 'export' %}true{% else %}false{% endif %}">
      Datenexport
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'design' %}active{% endif %}" id="design-tab"
            data-bs-toggle="tab" data-bs-target="#design-pane" type="button" role="tab"
            aria-controls="design-pane" aria-selected="{% if active_tab == 'design' %}true{% else %}false{% endif %}">
      Design
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'system' %}active{% endif %}" id="system-tab"
            data-bs-toggle="tab" data-bs-target="#system-pane" type="button" role="tab"
            aria-controls="system-pane" aria-selected="{% if active_tab == 'system' %}true{% else %}false{% endif %}">
      System
      {% if version_info.update_available %}
        <span class="badge bg-warning text-dark ms-1">!</span>
      {% endif %}
    </button>
  </li>
</ul>

<div class="tab-content" id="settingsTabsContent">
  <div class="tab-pane fade {% if active_tab == 'konten' %}show active{% endif %}" id="konten-pane" role="tabpanel" aria-labelledby="konten-tab">
    <div class="row g-4">
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm h-100">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">
              {% if edit_konto %}Konto bearbeiten{% else %}Neues Konto anlegen{% endif %}
            </h2>
          </div>
          <div class="card-body">
            <form method="post">
              {% if edit_konto %}
                <input type="hidden" name="konto_id" value="{{ edit_konto.id }}">
              {% endif %}
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name"
                       value="{{ edit_konto.name if edit_konto else '' }}"
                       placeholder="z.B. Girokonto ING" required>
              </div>
              <div class="mb-3">
                <label for="beschreibung" class="form-label">Beschreibung</label>
                <textarea class="form-control" id="beschreibung" name="beschreibung" rows="2"
                          placeholder="z.B. Hauptkonto Haushalt">{{ edit_konto.beschreibung if edit_konto else '' }}</textarea>
              </div>
              <div class="mb-3">
                <label for="iban" class="form-label">IBAN</label>
                <input type="text" class="form-control" id="iban" name="iban"
                       value="{{ edit_konto.iban if edit_konto else '' }}"
                       placeholder="z.B. DE00 1234 5678 9000 0000 00">
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-outline-success">
                  {% if edit_konto %}Konto aktualisieren{% else %}Konto speichern{% endif %}
                </button>
                {% if edit_konto %}
                  <a href="{{ url_for('settings.settings', tab='konten') }}" class="btn btn-outline-secondary">Abbrechen</a>
                {% endif %}
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Vorhandene Konten</h2>
          </div>
          <div class="card-body">
            {% if konten %}
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 25%;">Name</th>
                    <th style="width: 30%;">IBAN</th>
                    <th style="width: 10%;" class="text-center">Aktion</th>
                  </tr>
                </thead>
                <tbody>
                  {% for k in konten %}
                  <tr>
                    <td>{{ k.name }}</td>
                    <td>{{ k.iban }}</td>
                    <td class="text-center">
                      <div class="d-inline-flex gap-1">
                        <a href="{{ url_for('settings.settings', edit_id=k.id, tab='konten') }}"
                           class="btn btn-sm btn-primary d-inline-flex align-items-center justify-content-center"
                           style="width: 28px; height: 28px; padding: 0;"
                           title="Konto bearbeiten">
                          <!-- Stift-Icon wie bisher -->
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                          </svg>
                        </a>
                
                        <form method="post" style="display:inline;"
                              onsubmit="return confirm('Konto wirklich löschen? Es könnte in Buchungen verwendet werden.');">
                          <input type="hidden" name="form_type" value="konto_delete">
                          <input type="hidden" name="konto_id" value="{{ k.id }}">
                          <button type="submit"
                                  class="btn btn-sm btn-outline-danger d-inline-flex align-items-center justify-content-center"
                                  style="width: 28px; height: 28px; padding: 0;"
                                  title="Konto löschen">
                            <!-- Mülleimer-Icon im gleichen Line-Style -->
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2"
                                 stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="3 6 5 6 21 6"></polyline>
                              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                              <path d="M10 11v6"></path>
                              <path d="M14 11v6"></path>
                              <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                            </svg>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">Noch keine Konten angelegt.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade {% if active_tab == 'keywords' %}show active{% endif %}" id="keywords-pane" role="tabpanel" aria-labelledby="keywords-tab">
    <div class="row g-4">
      <!-- Stammdaten Kategorie (Tabelle category) -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header py-2">
            <h2 class="m-0 h6 text-uppercase text-muted">Kategorien (Stammdaten)</h2>
          </div>
          <div class="card-body">
            <form method="post" class="mb-3">
              <input type="hidden" name="form_type" value="category_master">
              <div class="mb-2">
                <label for="new_category_name" class="form-label mb-1">Neue Kategorie</label>
                <input type="text"
                       class="form-control form-control-sm"
                       id="new_category_name"
                       name="category_name"
                       placeholder="z.B. Supermarkt, Miete, Gehalt"
                       required>
              </div>
              <button type="submit" class="btn btn-sm btn-outline-success">
                Kategorie hinzufügen
              </button>
            </form>
            <div class="border-top pt-2">
              {% if categories_master %}
                <div class="small text-muted mb-1">Vorhandene Kategorien:</div>
                <div>
                  {% for c in categories_master %}
                    <span class="badge bg-light text-dark border me-1 mb-1 d-inline-flex align-items-center gap-1">
                      {{ c.name }}
                      <form method="post" style="display:inline;" onsubmit="return confirm('Kategorie wirklich löschen? Alle zugehörigen Zuordnungen werden ebenfalls gelöscht.');">
                        <input type="hidden" name="form_type" value="category_delete">
                        <input type="hidden" name="category_id" value="{{ c.id }}">
                        <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent text-danger" style="line-height: 1; font-size: 0.75rem;" title="Kategorie löschen">
                          ×
                        </button>
                      </form>
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted small mb-0">Noch keine Kategorien in der Stammtabelle angelegt.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Zuordnungen Kategorie & Schlüsselwort (keyword_category) -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm h-100">
          <div class="card-header py-1 d-flex justify-content-between align-items-center">
            <h2 class="m-0 h6 fw-bold">
              {% if edit_mapping %}Zuordnung bearbeiten{% else %}Neue Zuordnung anlegen{% endif %}
            </h2>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
                 data-bs-toggle="popover" 
                 data-bs-trigger="click"
                 data-bs-placement="top"
                 data-bs-html="true"
                 data-bs-content="<strong>Automatische Kategorisierung:</strong><br>Beim CSV-Import werden Buchungen automatisch der gewählten Kategorie zugeordnet, wenn das Schlüsselwort in der Beschreibung (Zahlungsempfänger oder Verwendungszweck) enthalten ist.<br><br><strong>Beispiel:</strong><br>Schlüsselwort: <code>REWE</code> → Kategorie: <code>Supermarkt</code><br>Buchung mit &quot;REWE Filiale 123&quot; wird automatisch als &quot;Supermarkt&quot; kategorisiert."
                 title="Wie funktionieren Zuordnungen?"
                 style="cursor: pointer; flex-shrink: 0;">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
            </svg>
          </div>
          <div class="card-body">
            <form method="post">
              <input type="hidden" name="form_type" value="keyword">
              {% if edit_mapping %}
                <input type="hidden" name="mapping_id" value="{{ edit_mapping.id }}">
              {% endif %}
              <div class="mb-3">
                <label for="category_name" class="form-label">Kategorie</label>
                <select class="form-select" id="category_name" name="category_name" required>
                  <option value="">Bitte wählen</option>
                  {% for c in categories_master %}
                    <option value="{{ c.name }}" {% if edit_mapping and edit_mapping.kategorie == c.name %}selected{% endif %}>
                      {{ c.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="keyword" class="form-label">Schlüsselwort</label>
                <input type="text"
                       class="form-control"
                       id="keyword"
                       name="keyword"
                       value="{{ edit_mapping.schluesselwort if edit_mapping else '' }}"
                       placeholder="z.B. EDEKA, AMAZON, PAYPAL"
                       required>
              </div>
              <button type="submit" class="btn btn-outline-success">
                {% if edit_mapping %}Zuordnung aktualisieren{% else %}Zuordnung speichern{% endif %}
              </button>              
              {% if edit_mapping %}
                <a href="{{ url_for('settings.settings', tab='keywords') }}" class="btn btn-outline-secondary ms-2">Abbrechen</a>
              {% endif %}
            </form>
            <form method="post" action="{{ url_for('actions.reload_categories') }}" class="mb-2">
              <button type="submit" class="btn btn-outline-secondary w-80 mt-2">
                Kategorien neu laden
              </button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Bestehende Zuordnungen</h2>
          </div>
          <div class="card-body">
            {% if keyword_mappings %}
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 30%;">Kategorie</th>
                    <th style="width: 40%;">Schlüsselwort</th>
                    <th style="width: 15%;" class="text-center">Aktion</th>
                  </tr>
                </thead>
                <tbody>
                  {% for m in keyword_mappings %}
                  <tr>
                    <td>{{ m.kategorie }}</td>
                    <td>{{ m.schluesselwort }}</td>
                    <td class="text-center">
                      <div class="d-inline-flex gap-1">
                        <a href="{{ url_for('settings.settings', tab='keywords', mapping_id=m.id) }}"
                           class="btn btn-sm btn-primary d-inline-flex align-items-center justify-content-center"
                           style="width: 28px; height: 28px; padding: 0;"
                           title="Zuordnung bearbeiten">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                               stroke="currentColor" stroke-width="2"
                               stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                          </svg>
                        </a>
                        <form method="post" style="display:inline;"
                              onsubmit="return confirm('Zuordnung wirklich löschen?');">
                          <input type="hidden" name="form_type" value="keyword_delete">
                          <input type="hidden" name="mapping_id" value="{{ m.id }}">
                          <button type="submit"
                                  class="btn btn-sm btn-outline-danger d-inline-flex align-items-center justify-content-center"
                                  style="width: 28px; height: 28px; padding: 0;"
                                  title="Zuordnung löschen">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2"
                                 stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="3 6 5 6 21 6"></polyline>
                              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                              <path d="M10 11v6"></path>
                              <path d="M14 11v6"></path>
                              <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                            </svg>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">Noch keine Zuordnungen angelegt.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade {% if active_tab == 'paperless' %}show active{% endif %}" id="paperless-pane" role="tabpanel" aria-labelledby="paperless-tab">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Paperless-Einstellungen</h2>
          </div>
          <div class="card-body">
            <form method="post">
              <input type="hidden" name="form_type" value="paperless">
              <div class="mb-3">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" role="switch" id="paperless_enabled" name="paperless_enabled"
                         {% if paperless_config.enabled %}checked{% endif %}>
                  <label class="form-check-label" for="paperless_enabled">
                    Paperless aktivieren
                  </label>
                </div>
              </div>
              <div class="mb-3">
                <label for="paperless_ip" class="form-label">Paperless IP-Adresse</label>
                <input type="text"
                       class="form-control"
                       id="paperless_ip"
                       name="paperless_ip"
                       value="{{ paperless_config.ip if paperless_config else '' }}"
                       placeholder="z.B. http://192.168.1.100:8000 oder https://paperless.example.com"
                       required>
                <div class="form-text">Vollständige URL oder IP-Adresse mit Port (z.B. http://192.168.1.100:8000)</div>
              </div>
              <div class="mb-3">
                <label for="paperless_token" class="form-label">API-Token</label>
                <input type="password"
                       class="form-control"
                       id="paperless_token"
                       name="paperless_token"
                       value="{{ paperless_config.token if paperless_config else '' }}"
                       placeholder="Ihr Paperless API-Token"
                       required>
                <div class="form-text">Der API-Token aus den Paperless-Einstellungen</div>
              </div>
              <div class="mb-3">
                <label for="document_type_id" class="form-label">Dokumententyp ID</label>
                <input type="text"
                       class="form-control"
                       id="document_type_id"
                       name="document_type_id"
                       value="{{ paperless_config.document_type_id if paperless_config else '' }}"
                       placeholder="z.B. 47"
                       required>
                <div class="form-text">ID des Dokumententyps in Paperless</div>
              </div>
              <button type="submit" class="btn btn-outline-success">
                Einstellungen speichern
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Tab -->
  <div class="tab-pane fade {% if active_tab == 'export' %}show active{% endif %}" id="export-pane" role="tabpanel" aria-labelledby="export-tab">
    <div class="row g-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Alle Buchungen als CSV exportieren</h2>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">
              Laden Sie alle Buchungen aus der Datenbank als CSV-Datei herunter. Die Datei enthält alle verfügbaren Felder und kann in Excel oder anderen Tabellenkalkulationsprogrammen geöffnet werden.
            </p>
            <div class="alert alert-info">
              <strong>Hinweis:</strong> Die CSV-Datei wird im deutschen Format erstellt (Semikolon als Trennzeichen, Komma als Dezimaltrennzeichen).
            </div>
            <a href="{{ url_for('settings.export_all_buchungen') }}" class="btn btn-outline-success">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Alle Buchungen als CSV herunterladen
            </a>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Buchungen aus CSV importieren</h2>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">
              Importieren Sie Buchungen aus einer CSV-Datei zurück in die Datenbank. Die Datei muss im deutschen Format sein (Semikolon als Trennzeichen, Komma als Dezimaltrennzeichen).
            </p>
            <div class="alert alert-warning">
              <strong>Hinweis:</strong> Duplikate werden automatisch erkannt und nicht importiert. Eine Buchung gilt als Duplikat, wenn Datum, Beschreibung, Soll, Haben, Konto und Gegen-IBAN identisch sind.
            </div>
            <form method="post" action="{{ url_for('settings.import_buchungen') }}" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="csv_file" class="form-label">CSV-Datei auswählen</label>
                <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                <div class="form-text">
                  Erwartete Spalten: Datum, Art, Beschreibung, Soll, Haben, Kategorie, Unterkategorie, Konto, Gegen-IBAN, Erstellt am
                </div>
              </div>
              <button type="submit" class="btn btn-outline-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                CSV-Datei importieren
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Design Tab -->
  <div class="tab-pane fade {% if active_tab == 'design' %}show active{% endif %}" id="design-pane" role="tabpanel" aria-labelledby="design-tab">
    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Design-Theme auswählen</h2>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">
              Wählen Sie ein Design-Theme für die Anwendung. Die Auswahl wird automatisch gespeichert und bleibt auch nach dem Neuladen der Seite erhalten.
            </p>
            
            <div class="row g-3">
              <!-- Standard Theme -->
              <div class="col-12 col-md-6">
                <div class="card theme-preview-card" data-theme="default" style="cursor: pointer; border: 2px solid transparent;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="mb-0">Standard</h5>
                      <input type="radio" name="theme" value="default" id="theme-default" class="form-check-input" checked>
                    </div>
                    <div class="theme-preview" style="height: 80px; border-radius: 8px; background: linear-gradient(135deg, #4f46e5 0%, #22c55e 100%); position: relative;">
                      <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 4px; font-size: 0.75rem; color: #0f172a;">
                        Moderne Indigo & Grün
                      </div>
                    </div>
                    <div class="mt-2 small text-muted">
                      <div>Akzent: Indigo (#4f46e5)</div>
                      <div>Sekundär: Grün (#22c55e)</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Midnight Theme -->
              <div class="col-12 col-md-6">
                <div class="card theme-preview-card" data-theme="midnight" style="cursor: pointer; border: 2px solid transparent;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="mb-0">Midnight</h5>
                      <input type="radio" name="theme" value="midnight" id="theme-midnight" class="form-check-input">
                    </div>
                    <div class="theme-preview" style="height: 80px; border-radius: 8px; background: linear-gradient(135deg, #16253D 0%, #002C54 50%, #EFB509 100%); position: relative;">
                      <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 4px; font-size: 0.75rem; color: #EFB509;">
                        Dunkles Theme mit Gold-Akzenten
                      </div>
                    </div>
                    <div class="mt-2 small text-muted">
                      <div>Akzent: Golden (#EFB509)</div>
                      <div>Sekundär: Bronze (#CD7213)</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Clean Theme -->
              <div class="col-12 col-md-6">
                <div class="card theme-preview-card" data-theme="clean" style="cursor: pointer; border: 2px solid transparent;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="mb-0">Clean</h5>
                      <input type="radio" name="theme" value="clean" id="theme-clean" class="form-check-input">
                    </div>
                    <div class="theme-preview" style="height: 80px; border-radius: 8px; background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%); position: relative;">
                      <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 4px; font-size: 0.75rem; color: #0f172a;">
                        Klares Blau-Design
                      </div>
                    </div>
                    <div class="mt-2 small text-muted">
                      <div>Akzent: Blau (#2563eb)</div>
                      <div>Sekundär: Sky (#0ea5e9)</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Dark Theme -->
              <div class="col-12 col-md-6">
                <div class="card theme-preview-card" data-theme="dark" style="cursor: pointer; border: 2px solid transparent;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="mb-0">Dark</h5>
                      <input type="radio" name="theme" value="dark" id="theme-dark" class="form-check-input">
                    </div>
                    <div class="theme-preview" style="height: 80px; border-radius: 8px; background: linear-gradient(135deg, #020617 0%, #6366f1 50%, #22d3ee 100%); position: relative;">
                      <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 4px; font-size: 0.75rem; color: #22d3ee;">
                        Dunkles Theme mit Indigo & Cyan
                      </div>
                    </div>
                    <div class="mt-2 small text-muted">
                      <div>Akzent: Indigo (#6366f1)</div>
                      <div>Sekundär: Cyan (#22d3ee)</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Green Theme -->
              <div class="col-12 col-md-6">
                <div class="card theme-preview-card" data-theme="green" style="cursor: pointer; border: 2px solid transparent;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="mb-0">Green</h5>
                      <input type="radio" name="theme" value="green" id="theme-green" class="form-check-input">
                    </div>
                    <div class="theme-preview" style="height: 80px; border-radius: 8px; background: linear-gradient(135deg, #16a34a 0%, #84cc16 100%); position: relative;">
                      <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(255,255,255,0.95); padding: 8px; border-radius: 4px; font-size: 0.75rem; color: #052e16;">
                        Natürliches Grün-Design
                      </div>
                    </div>
                    <div class="mt-2 small text-muted">
                      <div>Akzent: Grün (#16a34a)</div>
                      <div>Sekundär: Lime (#84cc16)</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Tab -->
  <div class="tab-pane fade {% if active_tab == 'system' %}show active{% endif %}" id="system-pane" role="tabpanel" aria-labelledby="system-tab">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header py-2">
            <h2 class="m-0 h6 fw-bold">Versionsinformationen</h2>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label fw-bold">Aktuelle Version:</label>
              <div class="fs-5">{{ version_info.current }}</div>
            </div>
            
            {% if version_info.error %}
              <div class="alert alert-warning">
                <strong>Hinweis:</strong> Versionsprüfung fehlgeschlagen: {{ version_info.error }}
              </div>
            {% elif version_info.latest %}
              <div class="mb-3">
                <label class="form-label fw-bold">Neueste Version auf Docker Hub:</label>
                <div class="fs-5">{{ version_info.latest }}</div>
              </div>
              
              {% if version_info.update_available %}
                <div class="alert alert-info">
                  <strong>Update verfügbar!</strong> Eine neuere Version ({{ version_info.latest }}) ist auf Docker Hub verfügbar.
                  <div class="mt-2">
                    <small>
                      Um zu aktualisieren, führen Sie aus:<br>
                      <code>docker pull sleepwalker86/finanzapp:{{ version_info.latest }}</code><br>
                      oder<br>
                      <code>docker compose pull && docker compose up -d</code>
                    </small>
                  </div>
                </div>
              {% else %}
                <div class="alert alert-success">
                  <strong>✓</strong> Sie verwenden die neueste Version.
                </div>
              {% endif %}
            {% else %}
              <div class="alert alert-secondary">
                Versionsinformationen werden geladen...
              </div>
            {% endif %}
            
            <div class="mt-3">
              <a href="https://hub.docker.com/r/sleepwalker86/finanzapp" 
                 target="_blank" 
                 class="btn btn-outline-primary btn-sm">
                Docker Hub öffnen
              </a>
              <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm ms-2">
                Versionsprüfung erneut durchführen
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Bootstrap Popovers initialisieren
  document.addEventListener('DOMContentLoaded', function() {
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });

    // Theme-Management
    const currentTheme = localStorage.getItem('theme') || 'default';
    
    // Aktuelles Theme im Radio-Button setzen
    const themeRadio = document.getElementById('theme-' + currentTheme);
    if (themeRadio) {
      themeRadio.checked = true;
    }

    // Theme-Vorschau-Karten markieren
    document.querySelectorAll('.theme-preview-card').forEach(card => {
      const theme = card.getAttribute('data-theme');
      if (theme === currentTheme) {
        card.style.borderColor = 'var(--accent)';
      }
    });

    // Theme-Wechsel Handler
    document.querySelectorAll('input[name="theme"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const selectedTheme = this.value;
        localStorage.setItem('theme', selectedTheme);
        
        // Theme auf HTML-Element anwenden
        if (selectedTheme === 'default') {
          document.documentElement.removeAttribute('data-theme');
        } else {
          document.documentElement.setAttribute('data-theme', selectedTheme);
        }

        // Vorschau-Karten aktualisieren
        document.querySelectorAll('.theme-preview-card').forEach(card => {
          const theme = card.getAttribute('data-theme');
          if (theme === selectedTheme) {
            card.style.borderColor = 'var(--accent)';
          } else {
            card.style.borderColor = 'transparent';
          }
        });
      });
    });

    // Klick auf Vorschau-Karte aktiviert auch das Radio-Button
    document.querySelectorAll('.theme-preview-card').forEach(card => {
      card.addEventListener('click', function(e) {
        // Nicht auslösen wenn direkt auf Radio-Button geklickt wurde
        if (e.target.type !== 'radio') {
          const theme = this.getAttribute('data-theme');
          const radio = document.getElementById('theme-' + theme);
          if (radio) {
            radio.checked = true;
            radio.dispatchEvent(new Event('change'));
          }
        }
      });
    });
  });
</script>
{% endblock %}




