{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Dashboard</h1>
  <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Zur Startseite</a>
</div>

<form method="get" class="row g-3 mb-4 align-items-end">
  <div class="col-3 col-md-3 col-sm-2 col-xs-1">
    <label for="year" class="form-label">Jahr</label>
    <input type="number" class="form-control" id="year" name="year" placeholder="z.B. 2025" value="{{ year }}" min="2000" max="2100">
  </div>
  <div class="col-3 col-md-3 col-sm-2">
    <label for="month" class="form-label">Monat</label>
    <input type="number" class="form-control" id="month" name="month" placeholder="1-12" value="{{ month }}" min="1" max="12">
  </div>
  <div class="col-12 col-md-6 col-sm-8">
    <button type="submit" class="btn btn-primary me-2">Filtern</button>
    <a href="{{ url_for('dashboard') }}" class="text-muted text-decoration-none">Filter löschen</a>
  </div>
  <input type="hidden" name="page" value="1">
</form>

<div class="row g-4 mb-4">
  <div class="col-12 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
    <h3 class="h5 mb-3">Kategorien (Einnahmen/Ausgaben)</h3>
    <canvas id="catChart" height="200"></canvas>
  </div>
  <div class="col-12 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
    <h3 class="h5 mb-3">Ausgaben (Kategorien)</h3>
    <canvas id="pieChart" height="200"></canvas>
  </div>
  <div class="col-12 col-md-4 col-lg-4 col-xl-4 col-xxl-4">
    <h3 class="h5 mb-3">Einzahlungen nach IBAN</h3>
    <canvas id="ibanChart" height="200"></canvas>
  </div>
</div>

<div class="mt-5">
  <h3 class="h5 mb-3">Buchungen ({{ total_buchungen }} Einträge)</h3>
  {% if buchungen %}
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th style="width: 10%;">Datum</th>
          <th class="d-none d-sm-table-cell" style="width: 10%;">Art</th>
          <th style="width: 25%;">Beschreibung</th>
          <th class="text-end" style="width: 15%;">Soll</th>
          <th class="text-end" style="width: 15%;">Haben</th>
          <th style="width: 15%;">Kategorie</th>
          <th class="text-center" style="width: 10%;">Aktion</th>
        </tr>
      </thead>
      <tbody>
        {% for b in buchungen %}
        <tr>
          <td>{{ b.datum.strftime('%d.%m.%Y') if b.datum else '' }}</td>
          <td class="d-none d-sm-table-cell">{{ b.art }}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ b.beschreibung }}">{{ b.beschreibung }}</td>
          <td class="text-end {% if b.soll > 0 %}text-danger{% else %}text-muted{% endif %}">
            {% if b.soll > 0 %}{{ "%.2f"|format(b.soll) }} €{% else %}-{% endif %}
          </td>
          <td class="text-end {% if b.haben > 0 %}text-success{% else %}text-muted{% endif %}">
            {% if b.haben > 0 %}{{ "%.2f"|format(b.haben) }} €{% else %}-{% endif %}
          </td>
          <td>{{ b.kategorie }}</td>
          <td class="text-center">
            <a href="{{ url_for('edit_buchung', buchung_id=b.id, year=year, month=month, page=current_page) }}" 
               class="btn btn-sm btn-primary d-inline-flex align-items-center justify-content-center"
               style="width: 28px; height: 28px; padding: 0;"
               title="Bearbeiten">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if total_pages > 1 %}
  <nav aria-label="Seitennavigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if current_page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('dashboard', year=year, month=month, page=current_page-1) }}">← Zurück</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">← Zurück</span>
      </li>
      {% endif %}
      
      <li class="page-item active">
        <span class="page-link">Seite {{ current_page }} von {{ total_pages }}</span>
      </li>
      
      {% if current_page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('dashboard', year=year, month=month, page=current_page+1) }}">Weiter →</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Weiter →</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  {% else %}
  <p class="text-muted mt-3">Keine Buchungen gefunden.</p>
  {% endif %}

  <form method="post" action="{{ url_for('reload_categories') }}" class="mt-3">
    <button type="submit" class="btn btn-outline-secondary">Kategorien neu laden</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const catCtx = document.getElementById('catChart');
  const pieCtx = document.getElementById('pieChart');
  const ibanCtx = document.getElementById('ibanChart');

  const labelsCat = {{ labels_cat|tojson }};
  const valuesHaben = {{ values_haben|tojson }};
  const valuesSoll = {{ values_soll|tojson }};

  // Farbpalette für Kategorien
  const colorPalette = [
    '#ef4444', '#f97316', '#f59e0b', '#10b981', '#3b82f6',
    '#8b5cf6', '#ec4899', '#14b8a6', '#a855f7', '#f472b6',
    '#06b6d4', '#84cc16', '#eab308', '#f43f5e', '#6366f1'
  ];

  // Datensätze für gestapeltes Diagramm: eine Kategorie = ein Datensatz
  const datasets = labelsCat.map((kategorie, index) => {
    return {
      label: kategorie,
      data: [valuesHaben[index] || 0, valuesSoll[index] || 0],
      backgroundColor: colorPalette[index % colorPalette.length]
    };
  });

  new Chart(catCtx, {
    type: 'bar',
    data: {
      labels: ['Einnahmen', 'Ausgaben'],
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: { 
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              label += new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
              return label;
            }
          }
        }
      },
      scales: { 
        x: { stacked: true },
        y: { 
          beginAtZero: true,
          stacked: true,
          ticks: {
            callback: function(value) {
              return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
            }
          }
        }
      }
    }
  });

  // Ausgaben-Pie (nutzt Soll-Werte)
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: labelsCat,
      datasets: [{
        label: 'Ausgaben',
        data: valuesSoll,
        backgroundColor: [
          '#ef4444','#f97316','#f59e0b','#10b981','#3b82f6',
          '#8b5cf6','#ec4899','#14b8a6','#a855f7','#f472b6'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });

  // Einzahlungen nach IBAN
  const labelsIban = {{ labels_iban|tojson }};
  const valuesIban = {{ values_iban|tojson }};

  // IBANs kürzen für bessere Lesbarkeit
  const shortLabels = labelsIban.map(iban => {
    if (!iban || iban === 'Unbekannt') return iban;
    // Zeige nur letzte 4 Ziffern: ...1234
    return '...' + iban.slice(-4);
  });

  new Chart(ibanCtx, {
    type: 'bar',
    data: {
      labels: shortLabels,
      datasets: [{
        label: 'Einzahlung (€)',
        data: valuesIban,
        backgroundColor: '#22c55e'
      }]
    },
    options: {
      responsive: true,
      plugins: { 
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: function(context) {
              const index = context[0].dataIndex;
              return labelsIban[index] || 'Unbekannt';
            },
            label: function(context) {
              return 'Einzahlung: ' + new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
            }
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
