{% extends "base.html" %}
{% from "macros.html" import filter_section %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Dashboard</h1>
</div>

<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Aktueller Saldo (gesamt)</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Buchungen (Haben - Soll). Zeigt den aktuellen Gesamtsaldo über alle Konten und Zeiträume hinweg."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0">
          {{ "%.2f"|format(total_saldo) }} €
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Einnahmen (akt. Monat)</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldeingänge (Haben-Spalte) im ausgewählten Zeitraum. Alle Einnahmen werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-success">
          {{ "%.2f"|format(total_haben) }} €
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Ausgaben (aktueller Monat)</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldausgänge (Soll-Spalte) im ausgewählten Zeitraum. Alle Ausgaben werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-danger">
          {{ "%.2f"|format(total_soll) }} €
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Cashflow</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: Einnahmen - Ausgaben. Zeigt das verbleibende Geld nach allen Ausgaben im ausgewählten Zeitraum. Positiv = Überschuss, negativ = Defizit."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(cashflow) }} €
        </div>
      </div>
    </div>
  </div>
</div>

{{ filter_section(url_for('dashboard'), year, selected_months, konto, kategorien, konten, kategorie_filter, kategorie2_filter) }}

<div class="row g-4 mb-4">
  <!-- Kategorien (Einnahmen/Ausgaben) -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Kategorien (Einnahmen/Ausgaben)</h3>
      </div>
      <div class="card-body">
        <div class="small text-muted mt-1 mb-2">
          Summe Einnahmen: {{ "%.2f"|format(total_haben) }} €<br>
          Summe Ausgaben: {{ "%.2f"|format(total_soll) }} €
        </div>
        <div class="chart-container">
          <canvas id="catChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Ausgaben-Pie -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Ausgaben (Kategorien)</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Einzahlungen nach IBAN -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Einzahlungen nach IBAN</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="ibanChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="h5 mb-0">Buchungen ({{ total_buchungen }} Einträge)</h3>
    {% if buchungen %}
    {% set query_parts = ['year=' + year|string] %}
    {% for m in (selected_months or []) %}
      {% set _ = query_parts.append('month=' + m) %}
    {% endfor %}
    {% if konto %}{% set _ = query_parts.append('konto=' + konto) %}{% endif %}
    {% if kategorie_filter %}{% set _ = query_parts.append('kategorie_filter=' + kategorie_filter) %}{% endif %}
    {% if kategorie2_filter %}{% set _ = query_parts.append('kategorie2_filter=' + kategorie2_filter) %}{% endif %}
    <a class="btn btn-sm btn-outline-secondary"
       href="{{ url_for('export_buchungen') }}?{{ query_parts|join('&') }}">
      CSV herunterladen
    </a>
    {% endif %}
  </div>
  {% if buchungen %}
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th style="width: 10%;">Datum</th>
          <th class="d-none d-lg-table-cell" style="width: 10%;">Art</th>
          <th style="width: 20%;">Beschreibung</th>
          <th style="width: 15%;">Kategorie</th>
          <th style="width: 15%;">Kategorie 2</th>
          <th class="text-end" style="width: 15%;">Soll</th>
          <th class="text-end" style="width: 15%;">Haben</th>
          <th class="text-center" style="width: 10%;">Aktion</th>
        </tr>
      </thead>
      <tbody>
        {% for b in buchungen %}
        <tr>
          <td>{{ b.datum.strftime('%d.%m.%Y') if b.datum else '' }}</td>
          <td class="d-none d-lg-table-cell">{{ b.art }}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ b.beschreibung }}">{{ b.beschreibung }}</td>
          <td>{{ b.kategorie }}</td>
          <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
              title="{{ b.kategorie2 }}">
            {{ b.kategorie2 if b.kategorie2 else '-' }}
          </td>
          <td class="text-end {% if b.soll > 0 %}text-danger{% else %}text-muted{% endif %}">
            {% if b.soll > 0 %}{{ "%.2f"|format(b.soll) }} €{% else %}-{% endif %}
          </td>
          <td class="text-end {% if b.haben > 0 %}text-success{% else %}text-muted{% endif %}">
            {% if b.haben > 0 %}{{ "%.2f"|format(b.haben) }} €{% else %}-{% endif %}
          </td>
          <td class="text-center">
            {% set edit_query = 'year=' + year|string + '&page=' + current_page|string %}
            {% for m in (selected_months or []) %}
              {% set edit_query = edit_query + '&month=' + m %}
            {% endfor %}
            <a href="{{ url_for('edit_buchung', buchung_id=b.id) }}?{{ edit_query }}" 
               class="btn btn-sm btn-primary d-inline-flex align-items-center justify-content-center"
               style="width: 28px; height: 28px; padding: 0;"
               title="Bearbeiten">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if total_pages > 1 %}
  <nav aria-label="Seitennavigation" class="mt-4">
    <ul class="pagination justify-content-center">
      {% set month_params = [] %}
      {% for m in (selected_months or []) %}
        {% set _ = month_params.append('month=' + m) %}
      {% endfor %}
      {% set month_query = month_params|join('&') %}
      {% set base_query = 'year=' + year|string + (('&' + month_query) if month_query else '') + (('&konto=' + konto) if konto else '') + (('&kategorie_filter=' + kategorie_filter) if kategorie_filter else '') + (('&kategorie2_filter=' + kategorie2_filter) if kategorie2_filter else '') %}
      {% if current_page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('dashboard') }}?{{ base_query }}&page={{ current_page-1 }}">← Zurück</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">← Zurück</span>
      </li>
      {% endif %}
      
      <li class="page-item active">
        <span class="page-link">Seite {{ current_page }} von {{ total_pages }}</span>
      </li>
      
      {% if current_page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('dashboard') }}?{{ base_query }}&page={{ current_page+1 }}">Weiter →</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Weiter →</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  {% else %}
  <p class="text-muted mt-3">Keine Buchungen gefunden.</p>
  {% endif %}
  
</div>

<style>
  .chart-container {
    position: relative;
    width: 100%;
    height: 260px; /* Desktop-Höhe */
  }
  
  @media (max-width: 768px) {
    .chart-container {
      height: 200px; /* Mobile-Höhe */
    }
  }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  const colorPalette = [
    '#ef4444','#f97316','#f59e0b','#10b981','#3b82f6',
    '#8b5cf6','#ec4899','#14b8a6','#a855f7','#f472b6',
    '#06b6d4','#84cc16','#eab308','#f43f5e','#6366f1'
  ];
  
  const labelsCat = {{ labels_cat|tojson }};
  const valuesHaben = {{ values_haben|tojson }};
  const valuesSoll = {{ values_soll|tojson }};
  
  function createCatDatasets() {
    return labelsCat.map((label, i) => ({
      label,
      data: [valuesHaben[i]||0, valuesSoll[i]||0],
      backgroundColor: colorPalette[i % colorPalette.length]
    }));
  }
  
  // Alle Charts generieren
  function createChart(ctx, type, data, options={}) {
    return new Chart(ctx, {
      type,
      data,
      options: Object.assign({ responsive:true, maintainAspectRatio:false }, options)
    });
  }
  
  // Kategorien
  createChart(
    document.getElementById('catChart').getContext('2d'),
    'bar',
    {
      labels:['Einnahmen','Ausgaben'],
      datasets:createCatDatasets()
    },
    {
      plugins: {
        legend: { position:'bottom' },
        tooltip: {
          callbacks: {
            label: ctx => {
              let val = ctx.parsed.y;
              return `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(val)}`;
            }
          }
        }
      },
      scales: { x:{stacked:true}, y:{stacked:true, beginAtZero:true, ticks:{callback:v=>new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(v)}} }
    }
  );
  
  // Pie-Chart Ausgaben
  createChart(
    document.getElementById('pieChart').getContext('2d'),
    'pie',
    {
      labels: labelsCat,
      datasets:[{
        label:'Ausgaben',
        data: valuesSoll,
        backgroundColor: colorPalette
      }]
    },
    { plugins:{ legend:{ position:'bottom' } } }
  );
  
  // IBAN
  const labelsIban = {{ labels_iban|tojson }};
  const valuesIban = {{ values_iban|tojson }};
  const shortLabels = labelsIban.map(i=>i&&i!=='Unbekannt'?'...'+i.slice(-4):i);
  
  createChart(
    document.getElementById('ibanChart').getContext('2d'),
    'bar',
    {
      labels: shortLabels,
      datasets:[{ label:'Einzahlung (€)', data: valuesIban, backgroundColor:'#22c55e' }]
    },
    {
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            title:ctx=>labelsIban[ctx[0].dataIndex]||'Unbekannt',
            label:ctx=>'Einzahlung: '+new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(ctx.parsed.y)
          }
        }
      },
      scales:{ y:{ beginAtZero:true, ticks:{callback:v=>new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(v)}} }
    }
  );
  
  document.addEventListener('DOMContentLoaded', function() {
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });
  });
  </script>
  {% endblock %}