{% extends "base.html" %}
{% from "macros.html" import filter_section %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Erweiterte Analyse</h1>
</div>

{{ filter_section(url_for('dashboard.analysis'), year, selected_months, konto, kategorien, konten, kategorie_filter, None, show_yoy=true, compare_year=compare_year, available_years=available_years) }}

{% if compare_year %}
<!-- KPI Cards mit YoY-Vergleich -->
<div class="row g-3 mb-4">
  {% set c = analysis_data.current %}
  {% set p = analysis_data.previous %}
  {% set d = analysis_data.deltas %}
  {% set dp = analysis_data.deltas_pct %}
  
  <!-- Einnahmen -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Einnahmen</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldeingänge (Haben-Spalte). Alle Einnahmen im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-success">{{ "%.2f"|format(c.haben) }} €</div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.2f"|format(p.haben) }} €<br>
          <span class="{% if d.haben >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.2f"|format(d.haben) }} € ({{ "%+.1f"|format(dp.haben) }}%)
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Ausgaben -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Ausgaben</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldausgänge (Soll-Spalte). Alle Ausgaben im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-danger">{{ "%.2f"|format(c.soll) }} €</div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.2f"|format(p.soll) }} €<br>
          <span class="{% if d.soll <= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.2f"|format(d.soll) }} € ({{ "%+.1f"|format(dp.soll) }}%)
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cashflow -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Cashflow</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: Einnahmen - Ausgaben. Zeigt das verbleibende Geld nach allen Ausgaben. Positiv = Überschuss, negativ = Defizit."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(c.cashflow) }} €
        </div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.2f"|format(p.cashflow) }} €<br>
          <span class="{% if d.cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.2f"|format(d.cashflow) }} € ({{ "%+.1f"|format(dp.cashflow) }}%)
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sparquote -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Sparquote</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: (Cashflow / Einnahmen) × 100. Zeigt den prozentualen Anteil des gesparten Geldes an den Einnahmen. PP = Prozentpunkte."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.sparquote >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.1f"|format(c.sparquote) }}%
        </div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.1f"|format(p.sparquote) }}%<br>
          <span class="{% if d.sparquote >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.1f"|format(d.sparquote) }} PP
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Diagramme -->
<div class="row g-4 mb-4">
  <!-- Einnahmen & Ausgaben YoY -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Einnahmen & Ausgaben{% if compare_year %} ({{ year }} vs {{ compare_year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="yoyBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cashflow-Verlauf -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Cashflow-Verlauf{% if compare_year %} ({{ year }} vs {{ compare_year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="yoyLineChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Kategorien YoY -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Kategorien-Vergleich{% if compare_year %} ({{ year }} vs {{ compare_year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 400px;">
          <canvas id="yoyCategoryChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<!-- Nur aktuelles Jahr ohne Vergleich -->
<div class="row g-3 mb-4">
  {% set c = analysis_data.current %}
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Einnahmen</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldeingänge (Haben-Spalte). Alle Einnahmen im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-success">{{ "%.2f"|format(c.haben) }} €</div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Ausgaben</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldausgänge (Soll-Spalte). Alle Ausgaben im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-danger">{{ "%.2f"|format(c.soll) }} €</div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Cashflow</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: Einnahmen - Ausgaben. Zeigt das verbleibende Geld nach allen Ausgaben. Positiv = Überschuss, negativ = Defizit."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(c.cashflow) }} €
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Sparquote</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: (Cashflow / Einnahmen) × 100. Zeigt den prozentualen Anteil des gesparten Geldes an den Einnahmen."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.sparquote >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.1f"|format(c.sparquote) }}%
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
  .chart-container {
    position: relative;
    width: 100%;
    height: 300px;
  }
  
  @media (max-width: 768px) {
    .chart-container {
      height: 250px;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if compare_year %}
const analysisData = {{ analysis_data|tojson }};
const currentYear = {{ year|int }};
const compareYear = {{ compare_year|int }};

// Einnahmen & Ausgaben YoY (Balkendiagramm)
const yoyBarCtx = document.getElementById('yoyBarChart').getContext('2d');
new Chart(yoyBarCtx, {
  type: 'bar',
  data: {
    labels: ['Einnahmen', 'Ausgaben'],
    datasets: [
      {
        label: `${currentYear}`,
        data: [analysisData.current.haben, analysisData.current.soll],
        backgroundColor: ['#10b981', '#ef4444']
      },
      {
        label: `${compareYear}`,
        data: [analysisData.previous.haben, analysisData.previous.soll],
        backgroundColor: ['#34d399', '#f87171']
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: ctx => {
            return `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(ctx.parsed.y)}`;
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: v => new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(v)
        }
      }
    }
  }
});

// Cashflow-Verlauf (Liniendiagramm)
const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
const currentTS = analysisData.current.timeseries;
const previousTS = analysisData.previous.timeseries;

// Arrays für alle 12 Monate füllen
const currentCashflow = new Array(12).fill(null);
const previousCashflow = new Array(12).fill(null);

currentTS.forEach(item => {
  currentCashflow[item.month - 1] = item.cashflow;
});
previousTS.forEach(item => {
  previousCashflow[item.month - 1] = item.cashflow;
});

const yoyLineCtx = document.getElementById('yoyLineChart').getContext('2d');
new Chart(yoyLineCtx, {
  type: 'line',
  data: {
    labels: months,
    datasets: [
      {
        label: `${currentYear}`,
        data: currentCashflow,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
      },
      {
        label: `${compareYear}`,
        data: previousCashflow,
        borderColor: '#94a3b8',
        backgroundColor: 'rgba(148, 163, 184, 0.1)',
        tension: 0.4,
        fill: true,
        borderDash: [5, 5]
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: ctx => {
            const val = ctx.parsed.y;
            return val !== null ? `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(val)}` : `${ctx.dataset.label}: Keine Daten`;
          }
        }
      }
    },
    scales: {
      y: {
        ticks: {
          callback: v => new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(v)
        }
      }
    }
  }
});

// Kategorien YoY (gestapeltes Balkendiagramm)
const currentCats = analysisData.current.categories;
const previousCats = analysisData.previous.categories;

// Alle Kategorien sammeln
const allCategories = new Set();
currentCats.forEach(c => allCategories.add(c.kategorie));
previousCats.forEach(c => allCategories.add(c.kategorie));
const categoryList = Array.from(allCategories).sort();

const currentCatSoll = categoryList.map(cat => {
  const found = currentCats.find(c => c.kategorie === cat);
  return found ? found.soll : 0;
});
const previousCatSoll = categoryList.map(cat => {
  const found = previousCats.find(c => c.kategorie === cat);
  return found ? found.soll : 0;
});

const yoyCategoryCtx = document.getElementById('yoyCategoryChart').getContext('2d');
new Chart(yoyCategoryCtx, {
  type: 'bar',
  data: {
    labels: categoryList,
    datasets: [
      {
        label: `${currentYear}`,
        data: currentCatSoll,
        backgroundColor: '#3b82f6'
      },
      {
        label: `${compareYear}`,
        data: previousCatSoll,
        backgroundColor: '#94a3b8'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: ctx => {
            return `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(ctx.parsed.y)}`;
          }
        }
      }
    },
    scales: {
      x: { stacked: true },
      y: {
        stacked: true,
        beginAtZero: true,
        ticks: {
          callback: v => new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(v)
        }
      }
    }
  }
});
{% endif %}

// Bootstrap Popovers initialisieren
document.addEventListener('DOMContentLoaded', function() {
  const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
  });
});
</script>
{% endblock %}

