{% extends "base.html" %}
{% from "macros.html" import filter_section %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Erweiterte Analyse</h1>
</div>

{{ filter_section(url_for('dashboard.analysis'), year, selected_months, konto, kategorien, konten, kategorie_filter, None, show_yoy=true, compare_year=compare_year, available_years=available_years) }}

{% if compare_year %}
<!-- KPI Cards mit YoY-Vergleich -->
<div class="row g-3 mb-4">
  {% set c = analysis_data.current %}
  {% set p = analysis_data.previous %}
  {% set d = analysis_data.deltas %}
  {% set dp = analysis_data.deltas_pct %}
  
  <!-- Einnahmen -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Einnahmen</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldeingänge (Haben-Spalte). Alle Einnahmen im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-success">{{ "%.2f"|format(c.haben) }} €</div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.2f"|format(p.haben) }} €<br>
          <span class="{% if d.haben >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.2f"|format(d.haben) }} € ({{ "%+.1f"|format(dp.haben) }}%)
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Ausgaben -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Ausgaben</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldausgänge (Soll-Spalte). Alle Ausgaben im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-danger">{{ "%.2f"|format(c.soll) }} €</div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.2f"|format(p.soll) }} €<br>
          <span class="{% if d.soll <= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.2f"|format(d.soll) }} € ({{ "%+.1f"|format(dp.soll) }}%)
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cashflow -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Cashflow</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: Einnahmen - Ausgaben. Zeigt das verbleibende Geld nach allen Ausgaben. Positiv = Überschuss, negativ = Defizit."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(c.cashflow) }} €
        </div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.2f"|format(p.cashflow) }} €<br>
          <span class="{% if d.cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.2f"|format(d.cashflow) }} € ({{ "%+.1f"|format(dp.cashflow) }}%)
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sparquote -->
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Sparquote</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: (Cashflow / Einnahmen) × 100. Zeigt den prozentualen Anteil des gesparten Geldes an den Einnahmen. PP = Prozentpunkte."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.sparquote >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.1f"|format(c.sparquote) }}%
        </div>
        <div class="small text-muted mt-1">
          {{ compare_year }}: {{ "%.1f"|format(p.sparquote) }}%<br>
          <span class="{% if d.sparquote >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ "%+.1f"|format(d.sparquote) }} PP
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Diagramme -->
<div class="row g-4 mb-4">
  <!-- Einnahmen & Ausgaben YoY -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Einnahmen & Ausgaben{% if compare_year %} ({{ year }} vs {{ compare_year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="yoyBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cashflow-Verlauf -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Cashflow-Verlauf{% if compare_year %} ({{ year }} vs {{ compare_year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="yoyLineChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Kategorien YoY -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Kategorien-Vergleich{% if compare_year %} ({{ year }} vs {{ compare_year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 400px;">
          <canvas id="yoyCategoryChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Kategorien-Analysen -->
<div class="row g-4 mb-4">
  <!-- Top-Kategorien nach Ausgaben -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Top-Kategorien nach Ausgaben{% if compare_year %} ({{ year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Rang</th>
                <th>Kategorie</th>
                <th class="text-end">Ausgaben</th>
                {% if compare_year %}
                <th class="text-end">{{ compare_year }}</th>
                {% endif %}
              </tr>
            </thead>
            <tbody id="topCategoriesTable">
              <!-- Wird per JavaScript gefüllt -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Anteil je Kategorie (%) -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Anteil je Kategorie (%){% if compare_year %} ({{ year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;">
          <canvas id="categoryPieChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<!-- Nur aktuelles Jahr ohne Vergleich -->
<div class="row g-3 mb-4">
  {% set c = analysis_data.current %}
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Einnahmen</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldeingänge (Haben-Spalte). Alle Einnahmen im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-success">{{ "%.2f"|format(c.haben) }} €</div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Ausgaben</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Summe aller Geldausgänge (Soll-Spalte). Alle Ausgaben im ausgewählten Zeitraum werden addiert."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 text-danger">{{ "%.2f"|format(c.soll) }} €</div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Cashflow</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: Einnahmen - Ausgaben. Zeigt das verbleibende Geld nach allen Ausgaben. Positiv = Überschuss, negativ = Defizit."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.cashflow >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(c.cashflow) }} €
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-header py-1 d-flex justify-content-between align-items-center">
        <span class="small text-muted">Sparquote</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="text-muted" 
             data-bs-toggle="popover" 
             data-bs-trigger="click"
             data-bs-placement="top"
             data-bs-content="Berechnung: (Cashflow / Einnahmen) × 100. Zeigt den prozentualen Anteil des gesparten Geldes an den Einnahmen."
             style="cursor: pointer; flex-shrink: 0;">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
      </div>
      <div class="card-body">
        <div class="h5 mb-0 {% if c.sparquote >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.1f"|format(c.sparquote) }}%
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Kategorien-Analysen (auch ohne Vergleichsjahr) -->
<div class="row g-4 mb-4">
  <!-- Top-Kategorien nach Ausgaben -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Top-Kategorien nach Ausgaben{% if compare_year %} ({{ year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Rang</th>
                <th>Kategorie</th>
                <th class="text-end">Ausgaben</th>
                {% if compare_year %}
                <th class="text-end">{{ compare_year }}</th>
                {% endif %}
              </tr>
            </thead>
            <tbody id="topCategoriesTable">
              <!-- Wird per JavaScript gefüllt -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Anteil je Kategorie (%) -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-header py-2">
        <h3 class="m-0 h6 fw-bold">Anteil je Kategorie (%){% if compare_year %} ({{ year }}){% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;">
          <canvas id="categoryPieChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
  .chart-container {
    position: relative;
    width: 100%;
    height: 300px;
  }
  
  @media (max-width: 768px) {
    .chart-container {
      height: 250px;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if compare_year %}
const analysisData = {{ analysis_data|tojson }};
const currentYear = {{ year|int }};
const compareYear = {{ compare_year|int }};

// Einnahmen & Ausgaben YoY (Balkendiagramm)
const yoyBarCtx = document.getElementById('yoyBarChart').getContext('2d');
new Chart(yoyBarCtx, {
  type: 'bar',
  data: {
    labels: ['Einnahmen', 'Ausgaben'],
    datasets: [
      {
        label: `${currentYear}`,
        data: [analysisData.current.haben, analysisData.current.soll],
        backgroundColor: ['#10b981', '#ef4444']
      },
      {
        label: `${compareYear}`,
        data: [analysisData.previous.haben, analysisData.previous.soll],
        backgroundColor: ['#34d399', '#f87171']
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: ctx => {
            return `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(ctx.parsed.y)}`;
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: v => new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(v)
        }
      }
    }
  }
});

// Cashflow-Verlauf (Liniendiagramm)
const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
const currentTS = analysisData.current.timeseries;
const previousTS = analysisData.previous.timeseries;

// Arrays für alle 12 Monate füllen
const currentCashflow = new Array(12).fill(null);
const previousCashflow = new Array(12).fill(null);

currentTS.forEach(item => {
  currentCashflow[item.month - 1] = item.cashflow;
});
previousTS.forEach(item => {
  previousCashflow[item.month - 1] = item.cashflow;
});

const yoyLineCtx = document.getElementById('yoyLineChart').getContext('2d');
new Chart(yoyLineCtx, {
  type: 'line',
  data: {
    labels: months,
    datasets: [
      {
        label: `${currentYear}`,
        data: currentCashflow,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
      },
      {
        label: `${compareYear}`,
        data: previousCashflow,
        borderColor: '#94a3b8',
        backgroundColor: 'rgba(148, 163, 184, 0.1)',
        tension: 0.4,
        fill: true,
        borderDash: [5, 5]
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: ctx => {
            const val = ctx.parsed.y;
            return val !== null ? `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(val)}` : `${ctx.dataset.label}: Keine Daten`;
          }
        }
      }
    },
    scales: {
      y: {
        ticks: {
          callback: v => new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(v)
        }
      }
    }
  }
});

// Kategorien YoY (gestapeltes Balkendiagramm)
const currentCatsYoY = analysisData.current.categories;
const previousCats = analysisData.previous.categories;

// Alle Kategorien sammeln
const allCategories = new Set();
currentCatsYoY.forEach(c => allCategories.add(c.kategorie));
previousCats.forEach(c => allCategories.add(c.kategorie));
const categoryList = Array.from(allCategories).sort();

const currentCatSoll = categoryList.map(cat => {
  const found = currentCatsYoY.find(c => c.kategorie === cat);
  return found ? found.soll : 0;
});
const previousCatSoll = categoryList.map(cat => {
  const found = previousCats.find(c => c.kategorie === cat);
  return found ? found.soll : 0;
});

const yoyCategoryCtx = document.getElementById('yoyCategoryChart').getContext('2d');
new Chart(yoyCategoryCtx, {
  type: 'bar',
  data: {
    labels: categoryList,
    datasets: [
      {
        label: `${currentYear}`,
        data: currentCatSoll,
        backgroundColor: '#3b82f6'
      },
      {
        label: `${compareYear}`,
        data: previousCatSoll,
        backgroundColor: '#94a3b8'
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: ctx => {
            return `${ctx.dataset.label}: ${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(ctx.parsed.y)}`;
          }
        }
      }
    },
    scales: {
      x: { stacked: true },
      y: {
        stacked: true,
        beginAtZero: true,
        ticks: {
          callback: v => new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(v)
        }
      }
    }
  }
});

// Top-Kategorien nach Ausgaben (Tabelle)
const currentCats = analysisData.current.categories;
const topCategories = currentCats
  .map(c => ({ kategorie: c.kategorie, soll: c.soll }))
  .filter(c => c.soll > 0)
  .sort((a, b) => b.soll - a.soll)
  .slice(0, 10); // Top 10

const totalSoll = topCategories.reduce((sum, c) => sum + c.soll, 0);
const topCategoriesTable = document.getElementById('topCategoriesTable');
topCategoriesTable.innerHTML = topCategories.map((cat, idx) => {
  const pct = totalSoll > 0 ? ((cat.soll / totalSoll) * 100).toFixed(1) : 0;
  let row = `<tr>
    <td>${idx + 1}</td>
    <td>${cat.kategorie}</td>
    <td class="text-end">${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(cat.soll)}</td>`;
  if (compareYear) {
    const prevCat = analysisData.previous.categories.find(c => c.kategorie === cat.kategorie);
    const prevSoll = prevCat ? prevCat.soll : 0;
    row += `<td class="text-end">${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(prevSoll)}</td>`;
  }
  row += `</tr>`;
  return row;
}).join('');

// Anteil je Kategorie (%) - Kreisdiagramm
const categoryPieCtx = document.getElementById('categoryPieChart').getContext('2d');
const pieLabels = topCategories.map(c => c.kategorie);
const pieData = topCategories.map(c => c.soll);
const pieColors = [
  '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
  '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#3b82f6'
];

new Chart(categoryPieCtx, {
  type: 'pie',
  data: {
    labels: pieLabels,
    datasets: [{
      data: pieData,
      backgroundColor: pieColors.slice(0, pieLabels.length),
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: {
          boxWidth: 12,
          padding: 8,
          font: { size: 11 }
        }
      },
      tooltip: {
        callbacks: {
          label: ctx => {
            const label = ctx.label || '';
            const value = new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(ctx.parsed);
            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((ctx.parsed / total) * 100).toFixed(1);
            return `${label}: ${value} (${percentage}%)`;
          }
        }
      }
    }
  }
});
{% endif %}

{% if not compare_year %}
// Für den Fall ohne Vergleichsjahr: Top-Kategorien und Kreisdiagramm
const analysisDataNoCompare = {{ analysis_data|tojson }};
const currentCatsNoCompare = analysisDataNoCompare.current.categories;

const topCategoriesNoCompare = currentCatsNoCompare
  .map(c => ({ kategorie: c.kategorie, soll: c.soll }))
  .filter(c => c.soll > 0)
  .sort((a, b) => b.soll - a.soll)
  .slice(0, 10);

const topCategoriesTableNoCompare = document.getElementById('topCategoriesTable');
if (topCategoriesTableNoCompare) {
  topCategoriesTableNoCompare.innerHTML = topCategoriesNoCompare.map((cat, idx) => {
    return `<tr>
      <td>${idx + 1}</td>
      <td>${cat.kategorie}</td>
      <td class="text-end">${new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(cat.soll)}</td>
    </tr>`;
  }).join('');
}

const categoryPieCtxNoCompare = document.getElementById('categoryPieChart');
if (categoryPieCtxNoCompare) {
  const pieLabelsNoCompare = topCategoriesNoCompare.map(c => c.kategorie);
  const pieDataNoCompare = topCategoriesNoCompare.map(c => c.soll);
  const pieColorsNoCompare = [
    '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#3b82f6'
  ];

  new Chart(categoryPieCtxNoCompare.getContext('2d'), {
    type: 'pie',
    data: {
      labels: pieLabelsNoCompare,
      datasets: [{
        data: pieDataNoCompare,
        backgroundColor: pieColorsNoCompare.slice(0, pieLabelsNoCompare.length),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            boxWidth: 12,
            padding: 8,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.label || '';
              const value = new Intl.NumberFormat('de-DE', {style: 'currency', currency: 'EUR'}).format(ctx.parsed);
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}
{% endif %}

// Bootstrap Popovers initialisieren
document.addEventListener('DOMContentLoaded', function() {
  const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  popoverTriggerList.map(function (popoverTriggerEl) {
    return new bootstrap.Popover(popoverTriggerEl);
  });
});
</script>
{% endblock %}

